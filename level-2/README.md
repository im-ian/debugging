# 📂 스텝 2: 다중 파일 업로드 로직 디버깅 실습 가이드

# 🎯 학습 목표

다중 파일 업로드 로직의 버그를 발견하고 수정하는 과정을 경험합니다.

# 📝 실습 가이드

## 1. 실습 시나리오

### 🪲 버그 리포트

당신은 신입 백엔드 개발자입니다. 당신의 입사 동기인 신입 프론트엔드 개발자로부터 파일 업로드 API에 뭔가 문제가 있다는 메시지를 받았습니다. 얼마전 퇴사한 동료가 만들어둔 API로, 당신은 아직 코드도 못 읽어본 상태입니다.

당신 동기의 말에 따르면 A 유저의 파일들은 업로드가 다 되는데, B 유저의 파일들은 업로드시 일부가 성공했다고 메시지는 나오지만 실제로는 아무것도 업로드가 되지 않는다고 합니다.

동기가 A 유저의 파일들과 B 유저의 파일들을 전달해주었습니다. 퇴사한 동료가 만들어둔 버그를 대신 고쳐봅시다.

### API 목록

- `POST /upload` : "files" key에 여러 파일을 formData 로 전송해서 업로드하고, 업로드 성공한 파일 목록을 응답으로 반환한다.
- `GET /files` : 서버에 업로드된 파일 목록을 반환한다.

## 2. 디버깅 마인드셋 템플릿을 활용한 문제 해결

### Step 1: 문제 정의

현재 풀고자 하는 문제를 한 문장으로 명확하게 정의해보세요.

특정 유저가 파일을 업로드 할때 성공했다는 메시지는 받지만 파일이 업로드 되지 않는 문제를 해결한다.

```
- 파일들을 업로드하려고 할 때, 실제로는 업로드가 되지 않았는데, 메시지는 일부만 업로드가 성공했다고 나오는 문제를 해결한다.

어떤 파일이 업로드가 안되는건지 패턴을 파악하고 싶다.
- 동료가 전해준 파일을 가지고 재현하는 실험을 해본다.
- 패턴이 파악되고 나면 뭘 할까?
  - 만약 이 패턴이 업로드가 되는제 정상이면, 실패하지 않게 업로드 로직을 변경한다.
  - 만약 이 패턴이 업로드 안되는 게 정상이라면, 검사해서 메시지(혹은 에러코드)를 변환하는 로직을 변경한다.
  - ...
```

### Step 2: 올바른 동작 정의

파일 업로드 기능이 올바르게 동작한다면 어떤 일이 벌어져야 하는지 정의해보세요. 이를 명확하게 정의하기 위해 올바른 동작을 given, when, then 형식으로 기술해보세요.

#### given

- B 유저는 파일을 업로드 시에 업로드 성공 메시지는 받지만 일부 파일이 실제로 업로드가 되지는 않는다.

#### when

- B 유저가 파일을 업로드 할때

#### then

- 모든 사용자는 파일을 업로드 시에 파일 업로드가 완료될 경우 성공 메시지를 보여준다.
- 모든 사용자는 파일 업로드에 성공 시 uploads 폴더에 파일이 업로드 되어야한다.
- 모든 사용자는 파일 업로드에 실패 시 실패 메시지를 전송해야한다.

```
- given: 유저가 파일을 하나만 선택해서 올린다.
- when: 허용되는 패턴이다.
- then: 업로드가 실제로 성공하고, 성공 메시지가 떠야한다.

- given: 유저가 파일을 2개 이상 선택해서 올린다.
- when: 허용되는 패턴이다.
- then: 업로드가 실제로 성공하고, 성공 메시지가 떠야한다.

- given: 유저가 파일을 2개 이상 선택해서 올린다.
- when: 1개 이상의 파일이 허용되는 패턴이 아니다.
- then: 업로드가 실제로 실패하고, 실패 메시지가 떠야한다.
- then: 실패 메시지 안에는 어떤 파일이 어떤 이유로 실패했는지 나와야한다.
```

### Step 3: 최소 재현 환경 구축하며 관찰

문제가 발생한 시점을 정확히 확인 후 내 환경에서 직접 재현하기 위해 문제가 있는 부분을 격리시켜보세요. 그리고 재현 환경과 정상 동작의 차이점을 관찰하고, 관찰한 내용을 적어보세요.

```
- 파일 2개를 업로드 했을 때는 성공했다.
- 파일 1개를 업로드 했을 때는 성공했다.
- 이미지 파일을 업로드 했을 때는 성공했다.
- svg 파일을 업로드 했을 때는 실패했다.
```

### Step 4: 차이를 발생시키는 다양한 원인 탐색

Step 3에서 관찰한 차이를 발생시키는 원인이 될 만한 옵션들을 자유롭게 적어보세요. 옵션을 적기 어렵다면 추가 정보를 수집해보세요.

- B 사용자는 파일 업로드 가능 용량보다 더 큰 용량의 파일을 업로드했다.
- B 사용자는 허용되지 않은 파일을 업로드했다.
- B 사용자는 세션, OS 등의 환경이 다르다.

```
- svg 확장자가 허용이 되지 않는다.
- 업로드가 불가한 파일의 용량이 너무 크다.
- 한번에 올릴 수 있는 파일의 갯수를 넘었다.
- 서버 용량이 꽉 찼다.
```

### Step 5: 가설 설정 및 검증

Step 4에서 도출한 옵션 중 하나를 선택하여 검증 가능한 가설을 세워보세요. 그리고 코드에 작은 변경을 가하면서 가설대로 현상이 변하는지 관찰해보세요.

만약 가설이 틀렸다면 그 이유를 적어보고, 다른 가설로 넘어가 반복해보세요.

- B 사용자는 파일 업로드 가능 용량보다 더 큰 용량의 파일을 업로드했다.
  - B 사용자는 `image_b2.svg`라는 큰 용량의 파일을 업로드하여 업로드 제한인 2mb를 초과해 업로드에 실패했다.
- B 사용자는 허용되지 않은 파일을 업로드했다.
  - 파일 업로드 로직은 사용되지 않았다.
- B 사용자는 세션, OS 등의 환경이 다르다.
  - 같은 OS와 환경에서도 동일한 현상이 일어난다.

```
svg 확장자가 문제라면?
- image_b1.jpg의 이름을 image_b1.svg로 변경한다면 업로드가 실패해야한다.
- 업로드 되지 않던 image_b2.svg를 image_b2.jpg로 변경한다면 업로드가 성공해야한다.

파일 용량이 문제라면?
- 업로드 가능한 파일과 불가능한 파일의 용량을 확인해본다.
- 코드에 용량 제한과 관련된 코드가 삽입 되어 있거나, 파일 업로드 라이브러리 디폴트 용량 설정이 있을 것이다.
- 사용자에게는 용량 문제로 업로드 되지 않았다는 피드백을 주어야한다.
```

<details>
<summary>힌트</summary>

- 파일 업로드 시 발생하는 오류를 처리하고, 사용자에게 에러 메시지를 반환해야 합니다.
- 예를 들어, 파일 크기 제한을 초과한 파일이 있을 때 각 파일의 업로드 상태를 기록하고, 에러 메시지를 포함하여 사용자에게 반환할 수 있습니다.

간단한 에러 처리 예시:

```jsx
app.post("/upload", (req, res) => {
  upload(req, res, (err) => {
    if (err) {
      return res.status(400).json({ message: err.message });
    }

    const uploadedFiles = req.files.map((file) => ({
      fileName: file.originalname,
      filePath: file.path,
      fileSize: file.size,
    }));

    res.json({
      message: "Files uploaded successfully.",
      files: uploadedFiles,
    });
  });
});
```

console을 이용하여 `err.code`를 출력하여 어떤 에러가 발생했는지 확인하고 이를 처리하는 방법을 생각해보세요.

</details>
